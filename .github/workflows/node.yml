name: anonNet Turbo Node
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Hardened & Optimized Setup
        run: |
          # 1. Gag the System (Zero Logs)
          sudo systemctl stop systemd-journald.socket systemd-journald-dev-log.socket || true
          sudo systemctl mask systemd-journald.service
          sudo rm -rf /var/log/*

          # 2. Network Turbo (BBR & Forwarding)
          sudo sysctl -w net.core.default_qdisc=fq
          sudo sysctl -w net.ipv4.tcp_congestion_control=bbr
          sudo sysctl -w net.ipv4.ip_forward=1

          # 3. Identity & Setup
          sudo apt-get update && sudo apt-get install -y wireguard
          S_PRIV=$(wg genkey)
          S_PUB=$(echo "$S_PRIV" | wg pubkey)
          IP=$(curl -s https://ifconfig.me)

          # 4. WireGuard Config (Port 443 + MTU 1280)
          cat <<EOF | sudo tee /etc/wireguard/wg0.conf
          [Interface]
          PrivateKey = $S_PRIV
          Address = 10.0.0.1/24
          ListenPort = 443
          MTU = 1280
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
          EOF
          sudo wg-quick up wg0

          # 5. Push to Public Registry
          echo "$IP:443,$S_PUB" > registry.txt
          git config user.name "anonnet-bot"
          git config user.email "bot@anonnet.io"
          git add registry.txt
          git commit -m "Turbo Rotate [skip ci]" || exit 0
          git push

      - name: Scrambler & Keep-Alive
        run: |
          while true; do
            # Send noise to client IP (10.0.0.2)
            head -c $((1 + RANDOM % 10)) /dev/urandom | nc -u -w1 10.0.0.2 443 || true
            sleep $((1 + RANDOM % 5))
          done &
          sleep 21000
